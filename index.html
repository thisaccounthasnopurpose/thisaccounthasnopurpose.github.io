<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational Monero Mining</title>
    
    <style>
        :root { --primary-bg: #1a1a1a; --secondary-bg: #2c2c2c; --text-color: #e0e0e0; --accent-color: #ff6600; --success-color: #4CAF50; --warning-color: #b30000; --info-color: #005f9e; --border-color: #444; --slider-track: #444; --slider-thumb: var(--accent-color); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 800px; width: 100%; }
        header h1 { color: var(--accent-color); text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .section { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .warning-box { background-color: var(--warning-color); color: white; padding: 15px; border-radius: 5px; text-align: center; font-weight: bold; }
        #blocker-warning { background-color: var(--info-color); color: white; padding: 15px; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
        .controls-grid, .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .disabled { opacity: 0.5; pointer-events: none; }
        .control-item { display: flex; flex-direction: column; justify-content: center; }
        .control-item label { margin-bottom: 10px; font-weight: bold; }
        .stat-item { background-color: var(--primary-bg); padding: 15px; border-radius: 5px; text-align: center; }
        .stat-item .label { display: block; font-size: 0.9em; color: #aaa; margin-bottom: 5px; }
        .stat-item .value { font-size: 1.5em; font-weight: bold; color: var(--accent-color); }
        .leaderboard { text-align: center; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .cpu-slider { -webkit-appearance: none; width: 100%; height: 15px; border-radius: 5px; background: var(--slider-track); outline: none; opacity: 0.7; transition: opacity .2s; }
        .cpu-slider:hover { opacity: 1; }
        .cpu-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; border-radius: 50%; background: var(--slider-thumb); cursor: pointer; }
        .cpu-slider::-moz-range-thumb { width: 25px; height: 25px; border-radius: 50%; background: var(--slider-thumb); cursor: pointer; }
        #cpuValue { font-weight: bold; color: var(--accent-color); }
        .education h2 { color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .education p { line-height: 1.6; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Educational Monero Miner</h1>
        </header>

        <div id="blocker-warning">
            A critical component was not loaded. If you are running a privacy extension (like Privacy Badger or uBlock Origin), please disable it for this site and reload the page.
        </div>
        
        <div class="section warning-box">
            <strong>Performance Warning:</strong> Enabling the miner will use your CPU resources, which may slow down your computer and will increase power consumption.
        </div>

        <div class="section controls" id="controls-section">
            <h2>Controls</h2>
            <div class="controls-grid">
                <div class="control-item">
                    <label for="miningToggle">Start / Stop Mining</label>
                    <label class="switch">
                        <input type="checkbox" id="miningToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="control-item">
                    <label for="cpuSlider">CPU Usage: <span id="cpuValue">50%</span></label>
                    <input type="range" min="1" max="100" value="50" class="cpu-slider" id="cpuSlider">
                </div>

                <div class="control-item">
                    <label for="timeoutOverrideToggle">Disable 1-Hour Timeout</label>
                    <label class="switch">
                        <input type="checkbox" id="timeoutOverrideToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="section stats">
            <h2>Live Session Data</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="label">XMR/USD Price</span>
                    <span class="value" id="moneroPrice">$--.--</span>
                </div>
                <div class="stat-item">
                    <span class="label">Hash Rate</span>
                    <span class="value" id="hashRate">0 H/s</span>
                </div>
                <div class="stat-item">
                    <span class="label">Session Hashes Submitted</span>
                    <span class="value" id="sessionHashes">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Hashes Accepted by Pool</span>
                    <span class="value" id="acceptedHashes">0</span>
                </div>
            </div>
        </div>
        
        <div class="section leaderboard">
            <h2>Personal Best</h2>
            <div class="stat-item">
                <span class="label">Most Hashes in a Single Session</span>
                <span class="value" id="personalBest">0</span>
            </div>
        </div>

        <div class="section education">
            <h2>What is Cryptojacking? (And Why This Isn't It)</h2>
            <p><strong>Cryptojacking</strong> is the malicious and unauthorized use of someone's computer to mine cryptocurrency. Attackers embed mining scripts on websites without the user's knowledge or consent. This website is an <strong>ethical alternative</strong>, built on transparency and user control.</p>
        </div>
    </div>

<script>
// --- EMBEDDED MINER LIBRARY (start) ---
// This is a browser-compatible, self-contained WebAssembly miner.
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Client=t():e.Client=t()}(window,function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=155)}([function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){e.exports=i(156)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(157),r=function(e,t){if(t=t||{},this._siteKey=e,this._user=null,this._threads=navigator.hardwareConcurrency||2,this._throttle=0,this._autoThreads=!1,this._optInToken=null,this._reconnectRetry=3,this._reconnectTime=1e4,this._forceWasm=!1,this._forceASMJS=!1,this._config=n.config.CRYPTONIGHT,this._token="anonymous",this.on("error",function(){}),this.on("open",function(){}),this.on("close",function(){}),this.on("authed",function(){}),this.on("job",function(){}),this.on("found",function(){}),this.on("accepted",function(){}),this.on("optin",function(){}),"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(this[i]=t[i]);this._autoThreads&&this.getAutoThreads(function(e){this._threads=e}.bind(this)),this._forceWasm&&!n.util.isWASMSupported()&&(this._forceWasm=!1),this._miner=null,this._socket=null,this._isPaused=!1,this._isWaitingForReconnect=!1,this._totalHashes=0,this._totalHashesMobile=0,this._hashesPerSecond=0,this._hashesPerSecondMobile=0,this._acceptedHashes=0,this._acceptedHashesMobile=0,this._threads=Math.max(1,this._threads),this._throttle=Math.max(0,Math.min(.99,this._throttle)),this.setThrottle.bind(this),this.setNumThreads.bind(this)};r.prototype.start=function(e){this._token=e||this._token,this.stop(),this._isPaused=!1,this._isWaitingForReconnect||this._startNow()},r.prototype.stop=function(){this._socket&&this._socket.close(),this._miner&&this._miner.stop(),this._isPaused=!0},r.prototype.getHashesPerSecond=function(){return this._hashesPerSecond.toFixed(1)},r.prototype.getHashesPerSecondMobile=function(){return this._hashesPerSecondMobile.toFixed(1)},r.prototype.getTotalHashes=function(e){return e?this._totalHashesMobile:this._totalHashes},r.prototype.getAcceptedHashes=function(e){return e?this._acceptedHashesMobile:this._acceptedHashes},r.prototype.getToken=function(){return this._optInToken},r.prototype.on=function(e,t){this.constructor.prototype[e]=t},r.prototype.getAutoThreads=function(e){var t=new n.JobThread;t.onmessage=function(i){t.terminate(),e(i.data.threads-1)},t.postMessage({type:"autothread"})},r.prototype.setNumThreads=function(e){this._threads=e,this._miner&&(this._miner.setNumThreads(e),this._startNow())},r.prototype.setThrottle=function(e){this._throttle=Math.max(0,Math.min(.99,e)),this._miner&&this._miner.setThrottle(e)},r.prototype._startNow=function(){this._isWaitingForReconnect||(this._socket=new n.Socket(this),this._socket.on("open",this._onOpen.bind(this)),this._socket.on("authed",this._onAuthed.bind(this)),this._socket.on("job",this._onJob.bind(this)),this._socket.on("accepted",this._onAccepted.bind(this)),this._socket.on("close",this._onClose.bind(this)),this._socket.on("error",this._onError.bind(this)),this._socket.connect())},r.prototype._onOpen=function(){this.on("open")},r.prototype._onAuthed=function(e){this._optInToken=e.token,this.on("authed",e),this.on("optin",e)},r.prototype._onJob=function(e){this._job=e,this.on("job",e),this._miner?this._miner.setJob(e):this._miner=new n.Miner(this._job,this._threads,this._throttle,this._forceWasm,this._forceASMJS),this._miner.on("found",this._onFound.bind(this)),this._miner.on("error",this._onError.bind(this)),this.setNumThreads(this._threads),this.setThrottle(this._throttle)},r.prototype._onFound=function(e){this.on("found",e),this._socket.send("submit",e)},r.prototype._onAccepted=function(e){this._acceptedHashes++,this._acceptedHashesMobile++,this.on("accepted",e)},r.prototype._onClose=function(e){this.on("close",e),this._socket.isWithError()?setTimeout(this._startNow.bind(this),this._reconnectTime):this._isWaitingForReconnect=!1},r.prototype._onError=function(e){this.on("error",e)},setInterval(function(){if(this._miner){var e=this._miner.getHashesPerSecond(),t=this._miner.getHashesPerSecondMobile();this._hashesPerSecond=.5*this._hashesPerSecond+.5*e,this._hashesPerSecondMobile=.5*this._hashesPerSecondMobile+.5*t;var i=this._miner.getTotalHashes(),n=this._miner.getTotalHashesMobile();this._totalHashes=i,this._totalHashesMobile=n}}.bind(r.prototype),1e3),r.User=function(e,t,i){var n=new r(e,i);n.start(t)},r.Anonymous=function(e,t){var i=new r(e,t);i.start("anonymous")},r.Token=function(e,t,i){var n=new r(e,i);n.start(t)},r.config=n.config,r.util=n.util,t.default=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.util=t.config=t.Miner=t.JobThread=t.Socket=void 0;var n=i(158);Object.defineProperty(t,"Socket",{enumerable:!0,get:function(){return r.default}});var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(n);var o=i(159);Object.defineProperty(t,"JobThread",{enumerable:!0,get:function(){return s.default}});var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(o);var a=i(160);Object.defineProperty(t,"Miner",{enumerable:!0,get:function(){return l.default}});var l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(a);var d=i(161);Object.defineProperty(t,"config",{enumerable:!0,get:function(){return p.default}});var p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(d);var c=i(162);Object.defineProperty(t,"util",{enumerable:!0,get:function(){return h.default}});var h=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(c)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){this._client=e,this._socket=null,this._withError=!1,this.on("open",function(){}),this.on("authed",function(){}),this.on("job",function(){}),this.on("accepted",function(){}),this.on("close",function(){}),this.on("error",function(){})};n.prototype.connect=function(){var e=this._client._config.WEBSOCKET_SHARDS,t=Math.floor(Math.random()*e.length),i=e[t];this._socket=new WebSocket(i),this._socket.onmessage=this._onMessage.bind(this),this._socket.onopen=this._onOpen.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this)},n.prototype.on=function(e,t){n.prototype[e]=t},n.prototype.send=function(e,t){var i={type:e,params:t};this._socket.send(JSON.stringify(i))},n.prototype.close=function(){this._socket.close()},n.prototype.isWithError=function(){return this._withError},n.prototype._onOpen=function(){this._withError=!1;var e={site_key:this._client._siteKey,type:"anonymous",user:null,goal:0};this._client._user&&(e.type="user",e.user=this._client._user.toString()),this.send("auth",e),this.on("open")},n.prototype._onMessage=function(e){var t;try{t=JSON.parse(e.data)}catch(e){return void this.on("error",{error:"JSON.parse() error"})}if("authed"===t.type)this._authed=!0,this._auth=t.params,this.on("authed",t.params);else if("job"===t.type)this._job=t.params,this.on("job",t.params);else if("hash_accepted"===t.type)this._hashes=t.params,this.on("accepted",t.params);else if("error"===t.type)this.on("error",t.params);else if("banned"===t.type||"invalid_site_key"===t.type||"invalid_opt_in"===t.type||"auth_required"===t.type){var i=new Error(t.params.error);i.code="connection."+t.type,this.on("error",i)}},n.prototype._onClose=function(){this.on("close",{wasClean:this._socket.isReady}),this._socket.isReady=!0},n.prototype._onError=function(e){this.on("error",{error:"Socket error"}),this._withError=!0},t.default=n},function(e,t,i){"use a=b;var c=1;"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(159),r=function(e,t,i,o,s){this._job=e,this._threads=t,this._throttle=i,this._forceWasm=o,this._forceASMJS=s,this._hashes=0,this._hashesMobile=0,this._threadsContainers=[],this.on("found",function(){}),this.on("error",function(){})};r.prototype.start=function(){this._stopThreads(),this._hashes=0,this._hashesMobile=0,this._startThreads()},r.prototype.stop=function(){this._stopThreads()},r.prototype.getHashesPerSecond=function(){for(var e=0,t=0;t<this._threadsContainers.length;t++)e+=this._threadsContainers[t].hashesPerSecond;return e},r.prototype.getHashesPerSecondMobile=function(){for(var e=0,t=0;t<this._threadsContainers.length;t++)e+=this._threadsContainers[t].hashesPerSecondMobile;return e},r.prototype.getTotalHashes=function(){return this._hashes},r.prototype.getTotalHashesMobile=function(){return this._hashesMobile},r.prototype.setJob=function(e){this._job=e},r.prototype.setNumThreads=function(e){if(e>this._threadsContainers.length){for(var t=this._threadsContainers.length;t<e;t++)this._startThread(t);this._threads=this._threadsContainers.length}else if(e<this._threadsContainers.length)for(var t=this._threadsContainers.length;t>e;t--)this._stopThread(t-1)},r.prototype.setThrottle=function(e){this._throttle=e;for(var t=0;t<this._threadsContainers.length;t++)this._threadsContainers[t].throttle=e},r.prototype.on=function(e,t){r.prototype[e]=t},r.prototype._startThreads=function(){for(var e=0;e<this._threads;e++)this._startThread(e)},r.prototype._startThread=function(e){var t=new n.JobThread;t.onmessage=this._onMessage.bind(this);var i={job:this._job,thread_id:e,forceWasm:this._forceWasm,forceASMJS:this._forceASMJS};t.postMessage(i),this._threadsContainers[e]={thread:t,isMobile:this.isMobile()}},r.prototype._stopThreads=function(){for(var e=0;e<this._threadsContainers.length;e++)this._threadsContainers[e].thread.terminate(),this._threadsContainers[e].isMobile?this._hashesMobile+=this._threadsContainers[e].hashes:this._hashes+=this._threadsContainers[e].hashes;this._threadsContainers=[]},r.prototype._stopThread=function(e){this._threadsContainers[e].thread.terminate(),this._threadsContainers[e].isMobile?this._hashesMobile+=this._threadsContainers[e].hashes:this._hashes+=this._threadsContainers[e].hashes,this._threadsContainers.splice(e,1)},r.prototype._onMessage=function(e){if(e.data.result){this.on("found",e.data.result);var t=e.data.result.thread_id;this._threadsContainers[t].isMobile?this._hashesMobile+=this._threadsContainers[t].hashes:this._hashes+=this._threadsContainers[t].hashes,this._threadsContainers[t].hashes=0}this._threadsContainers[e.data.thread_id].hashes=e.data.hashes,this._threadsContainers[e.data.thread_id].hashesPerSecond=e.data.hashesPerSecond},r.prototype.isMobile=function(){return/Mobi|Android/i.test(navigator.userAgent)},t.default=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={WEBSOCKET_SHARDS:["wss://webminerpool.com:8181"],CRYPTONIGHT_WAS_URL:"/crypto-night.wasm"};t.default={CRYPTONIGHT:n}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={isWASMSupported:function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1},isMobile:function(){return/Mobi|Android/i.test(navigator.userAgent)},GetDomain:function(e){var t=document.createElement("a");return t.href=e,t.hostname}}}]).default});
// --- EMBEDDED MINER LIBRARY (end) ---

// --- APPLICATION LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
    // Check if the embedded miner client loaded correctly.
    if (typeof Client === 'undefined' || typeof Client.Anonymous !== 'function') {
        console.error("Miner client (Client) not found. The embedded script may have failed to initialize.");
        document.getElementById('blocker-warning').style.display = 'block';
        document.getElementById('controls-section').classList.add('disabled');
        return; // Halt execution if the miner is not available.
    }

    // --- CONFIGURATION ---
    const MONERO_WALLET_ADDRESS = '48TjjUjavn7fjTQTj9uUwwf2WXQD55MRYebih88G4VnTUPy8ivTEwKJFHZx5DREWWF5QZXkUqYbFq6Uvnq7iw7mHC4seyxZ';
    const MINING_TIMEOUT_MS = 60 * 60 * 1000; // 1 hour

    // --- DOM ELEMENT REFERENCES ---
    const miningToggle = document.getElementById('miningToggle');
    const timeoutOverrideToggle = document.getElementById('timeoutOverrideToggle');
    const cpuSlider = document.getElementById('cpuSlider');
    const cpuValueSpan = document.getElementById('cpuValue');
    const moneroPriceSpan = document.getElementById('moneroPrice');
    const hashRateSpan = document.getElementById('hashRate');
    const sessionHashesSpan = document.getElementById('sessionHashes');
    const acceptedHashesSpan = document.getElementById('acceptedHashes');
    const personalBestSpan = document.getElementById('personalBest');

    // --- STATE VARIABLES ---
    let miner = null;
    let miningTimeoutId = null;
    let statsUpdateIntervalId = null;

    // --- INITIALIZATION ---
    const personalBest = localStorage.getItem('personalBestHashes') || '0';
    personalBestSpan.textContent = parseInt(personalBest).toLocaleString();
    fetchMoneroPrice();
    setInterval(fetchMoneroPrice, 5 * 60 * 1000); // Fetch price every 5 minutes.

    // --- CORE FUNCTIONS ---
    async function fetchMoneroPrice() {
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=monero&vs_currencies=usd');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            moneroPriceSpan.textContent = `$${data.monero.usd.toFixed(2)}`;
        } catch (error) {
            console.error('Failed to fetch Monero price:', error);
            moneroPriceSpan.textContent = '$--.--';
        }
    }
    
    function startMining() {
        const throttle = 1 - (parseInt(cpuSlider.value, 10) / 100);
        
        miner = new Client.Anonymous(MONERO_WALLET_ADDRESS, {
            throttle: throttle,
            c: 'w' // Use 'w' to force WASM (WebAssembly) for better performance
        });

        // Reset session stats
        sessionHashesSpan.textContent = '0';
        acceptedHashesSpan.textContent = '0';

        setupMinerEventListeners();
        miner.start();
        console.log('Mining started.');
        
        statsUpdateIntervalId = setInterval(updateStats, 1000);

        if (!timeoutOverrideToggle.checked) {
            miningTimeoutId = setTimeout(() => {
                console.log('Automatic 1-hour timeout reached.');
                miningToggle.checked = false; // This will trigger the change event to stop everything
            }, MINING_TIMEOUT_MS);
        }
    }

    function stopMining() {
        if (!miner) return;

        updatePersonalBest(miner.getTotalHashes(false)); // Pass false for non-mobile hashes
        
        miner.stop();
        console.log('Mining stopped.');
        
        // Clear all intervals and references
        clearInterval(statsUpdateIntervalId);
        clearTimeout(miningTimeoutId);
        statsUpdateIntervalId = null;
        miningTimeoutId = null;
        miner = null; 

        // Reset dynamic displays
        hashRateSpan.textContent = '0 H/s';
    }

    function setupMinerEventListeners() {
        if (!miner) return;

        miner.on('accepted', () => {
            const currentAccepted = parseInt(acceptedHashesSpan.textContent.replace(/,/g, '')) || 0;
            acceptedHashesSpan.textContent = (currentAccepted + 1).toLocaleString();
        });

        miner.on('error', (err) => {
            // The library sends frequent "connection_error" events during normal operation, so we ignore them.
            if (err.error && err.error !== 'connection_error') {
                console.error('Miner error:', err.error);
            }
        });
    }

    function updateStats() {
        if (!miner) return;
        
        const hps = miner.getHashesPerSecond();
        const totalHashes = miner.getTotalHashes(false); // Pass false for non-mobile hashes
        
        hashRateSpan.textContent = `${parseFloat(hps).toFixed(2)} H/s`;
        sessionHashesSpan.textContent = Math.round(totalHashes).toLocaleString();
    }
    
    function updatePersonalBest(currentSessionHashes) {
        const oldBest = parseInt(localStorage.getItem('personalBestHashes') || '0', 10);
        const roundedHashes = Math.round(currentSessionHashes);
        if (roundedHashes > oldBest) {
            console.log(`New personal best: ${roundedHashes} hashes!`);
            localStorage.setItem('personalBestHashes', roundedHashes);
            personalBestSpan.textContent = roundedHashes.toLocaleString();
        }
    }

    // --- EVENT LISTENERS ---
    miningToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            startMining();
        } else {
            stopMining();
        }
    });

    cpuSlider.addEventListener('input', (e) => {
        const cpuPercentage = parseInt(e.target.value, 10);
        cpuValueSpan.textContent = `${cpuPercentage}%`;
        
        if (miner) {
            const throttle = 1 - (cpuPercentage / 100);
            miner.setThrottle(throttle);
        }
    });

    timeoutOverrideToggle.addEventListener('change', (e) => {
        if (miningToggle.checked) { // Only act if mining is active
            clearTimeout(miningTimeoutId);
            miningTimeoutId = null;
            if (!e.target.checked) { // If the override is turned OFF, set a new timeout
                miningTimeoutId = setTimeout(() => {
                    console.log('Automatic 1-hour timeout re-enabled and reached.');
                    miningToggle.checked = false;
                }, MINING_TIMEOUT_MS);
            }
        }
    });
});
</script>

</body>
</html>
